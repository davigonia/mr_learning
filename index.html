<!DOCTYPE html>
<html lang="en" style="overflow-x: hidden; width: 100%;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>Mr. Learning - Kids Voice Learning App</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&family=Nunito:wght@400;600&family=Baloo+2:wght@800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Custom styles */
        html, body {
            max-width: 100%;
            overflow-x: hidden;
            overscroll-behavior-x: none;
        }
        body {
            background-attachment: fixed;
        }
        
        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #BEE3F8, #FED7E2, #C7D2FE);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
            width: 100%;
            position: relative;
        }
        
        h1 {
            font-family: 'Baloo 2', cursive;
            font-weight: 800;
            font-size: clamp(2.5rem, 8vw, 4.5rem);
            text-align: center;
            background: linear-gradient(to right, #FF2E63, #00C4B4, #7F7FD5);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.1);
            letter-spacing: -0.5px;
            line-height: 1.1;
            transform: scale(2.5);
            max-width: 100%;
            margin-bottom: 0.5em;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem 2rem 2rem;
            position: relative;
        }
        
        .ask-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.3s ease;
            width: min(280px, 70vw);
            height: min(280px, 70vw);
            border-radius: 50%;
            background: linear-gradient(145deg, #00D084, #00C4B4);
            box-shadow: 
                0 10px 20px rgba(0, 0, 0, 0.15),
                0 6px 6px rgba(0, 0, 0, 0.1),
                0 -2px 6px rgba(255, 255, 255, 0.2) inset;
            border: 8px solid rgba(255, 255, 255, 0.5);
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .ask-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 30%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.3), rgba(255,255,255,0));
            border-radius: 50% 50% 100% 100% / 100% 100% 0% 0%;
        }
        
        .ask-button:active {
            transform: scale(0.95) translateY(10px);
            box-shadow: 
                0 5px 10px rgba(0, 0, 0, 0.2),
                0 3px 3px rgba(0, 0, 0, 0.1),
                0 -2px 6px rgba(255, 255, 255, 0.2) inset;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .pulsing {
            animation: pulse 0.5s infinite;
        }
        
        .spinner {
            width: 70px;
            height: 70px;
            border: 10px solid #FF2E63;
            border-top: 10px solid #00D084;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 1.5rem auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .feedback-text {
            font-size: 1.5rem;
            font-weight: 600;
            color: #4A5568;
            margin-top: 1.5rem;
            text-align: center;
        }
        
        .answer-text {
            font-size: 1.25rem;
            line-height: 1.6;
            color: #2D3748;
            margin-top: 1.5rem;
            text-align: center;
            max-width: 90%;
            background-color: rgba(255, 255, 255, 0.5);
            padding: 1rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        .parent-access-container {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-top: 2rem;
        }
        
        .parent-access-button {
            background: linear-gradient(145deg, #D6BCFA, #B794F4);
            color: #2D3748;
            font-family: 'Poppins', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 1.5rem;
            border: none;
            box-shadow: 
                0 4px 6px rgba(0, 0, 0, 0.1),
                0 1px 3px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .parent-access-button:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 7px 14px rgba(0, 0, 0, 0.1),
                0 3px 6px rgba(0, 0, 0, 0.08);
        }
        
        .parent-access-button:active {
            transform: translateY(1px);
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background-color: #EDF2F7;
            border-radius: 16px;
            padding: clamp(0.8rem, 3vw, 1.5rem);
            width: 85%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .pin-input {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin: 1rem 0;
        }
        
        .pin-input input {
            width: clamp(2rem, 8vw, 3rem);
            height: clamp(2rem, 8vw, 3rem);
            text-align: center;
            font-size: clamp(1rem, 4vw, 1.5rem);
            border: 2px solid #CBD5E0;
            border-radius: 8px;
        }
        
        .dashboard {
            display: none;
        }
        
        .dashboard-section {
            margin-bottom: clamp(1rem, 3vw, 1.5rem);
            padding-bottom: clamp(1rem, 3vw, 1.5rem);
            border-bottom: 1px solid #E2E8F0;
        }
        
        .dashboard-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .text-input-container {
            display: flex;
            width: 100%;
            max-width: 500px;
            margin: 1.5rem auto;
        }
        
        .question-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 1.5rem 0 0 1.5rem;
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
        }
        
        .text-ask-button {
            background: linear-gradient(145deg, #00D084, #00C4B4);
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0 1.5rem 1.5rem 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Mr. Learning</h1>
    
    <div class="credit" style="font-size: clamp(0.7rem, 2vw, 0.9rem); opacity: 0.7; margin-top: 1rem; margin-bottom: 2rem; font-family: 'Nunito', sans-serif;">Made with love by David Cheang <a href="https://instagram.com/dadnotehk" target="_blank" style="color: #FF2E63; text-decoration: none;">@dadnotehk</a></div>
    

    
    <div class="container">
        <button id="askButton" class="ask-button">
            <i class="fas fa-microphone text-white text-4xl"></i>
            <span>Ask Me Anything</span>
        </button>

        <!-- iOS notice -->
        <div class="ios-note" style="margin: 0.5em 0 1em 0; font-size: 0.97em; color: #FF2E63; background: #fff0f3; border-radius: 0.75em; padding: 0.5em 1em; text-align: center; max-width: 500px; margin-left: auto; margin-right: auto;">
            <i class="fas fa-info-circle" style="margin-right: 0.4em;"></i>
            <span>iPhone/iPad users: Please use the text input box below, as voice input/output may not work on iOS browsers.</span>
        </div>
        
        <!-- Add text input fallback for iOS users -->
        <div class="text-input-container">
            <input 
                type="text" 
                id="questionInput" 
                class="question-input" 
                placeholder="Type your question here..." 
            >
            <button 
                id="textAskButton" 
                class="text-ask-button"
            >
                Ask
            </button>
        </div>
        <div style="width:100%;max-width:500px;margin:0 auto 1rem auto;display:flex;align-items:center;gap:0.6em;justify-content:center">
            <label style="display:flex;align-items:center;gap:0.4em;font-size:1rem;cursor:pointer;user-select:none;">
                <input type="checkbox" id="voiceOutputToggle" checked style="accent-color:#00C4B4;width:1.1em;height:1.1em;">
                Voice Output
            </label>
            <span id="voiceOutputStatus" style="font-size:0.95em;color:#00C4B4;font-weight:600;">On</span>
        </div>
        
        <div id="feedback" class="feedback-text"></div>
        <div id="spinner" class="spinner" style="display: none;"></div>
        <div id="answer" class="answer-text"></div>
        
        <div class="parent-access-container">
            <button id="parentAccessButton" class="parent-access-button">
                Parent Access
            </button>
        </div>
    </div>
    
    <!-- Parent Access Modal -->
    <div id="parentModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div id="pinScreen">
                <h2 class="text-xl font-bold font-[Poppins] text-center mb-4">Parent Access</h2>
                <p class="text-gray-600 font-[Nunito] text-center mb-2">Enter 4-digit PIN</p>
                
                <div class="pin-input">
                    <input type="password" maxlength="1" class="pin-digit">
                    <input type="password" maxlength="1" class="pin-digit">
                    <input type="password" maxlength="1" class="pin-digit">
                    <input type="password" maxlength="1" class="pin-digit">
                </div>
                
                <p id="pinError" class="text-red-500 font-[Nunito] text-sm text-center hidden">Wrong PIN, try again!</p>
                
                <div class="flex justify-center gap-4 mt-4">
                    <button id="submitPinButton" class="bg-green-500 text-white rounded-lg px-4 py-2 font-[Poppins] text-sm">Submit</button>
                    <button id="cancelPinButton" class="bg-red-200 text-gray-800 rounded-lg px-4 py-2 font-[Poppins] text-sm">Cancel</button>
                </div>
            </div>
            
            <div id="dashboard" class="dashboard">
                <h2 class="text-xl font-bold font-[Poppins] text-center mb-4">Parent Dashboard</h2>
                
                <!-- Banned Words Section -->
                <div class="dashboard-section">
                    <h3 class="text-lg font-bold font-[Poppins] mb-2">Banned Words</h3>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="newBannedWord" class="border border-gray-300 rounded-lg p-2 font-[Nunito] text-base flex-grow" placeholder="Add new word">
                        <button id="addBannedWordButton" class="bg-green-500 text-white rounded-lg px-4 py-2 font-[Poppins] text-sm">Add</button>
                    </div>
                    <div id="bannedWordsList" class="mt-2 flex flex-wrap gap-2"></div>
                </div>
                
                <!-- Change PIN Section -->
                <div class="dashboard-section">
                    <h3 class="text-lg font-bold font-[Poppins] mb-2">Change PIN</h3>
                    <div class="flex flex-col gap-2">
                        <input type="password" id="newPin" class="border border-gray-300 rounded-lg p-2 font-[Nunito] text-base" placeholder="New 4-digit PIN" maxlength="4">
                        <input type="password" id="confirmPin" class="border border-gray-300 rounded-lg p-2 font-[Nunito] text-base" placeholder="Confirm PIN" maxlength="4">
                        <p id="pinChangeError" class="text-red-500 font-[Nunito] text-sm hidden">PINs don't match or not 4 digits!</p>
                        <button id="changePinButton" class="bg-green-500 text-white rounded-lg px-4 py-2 font-[Poppins] text-sm mt-2">Update PIN</button>
                    </div>
                </div>
                
                <!-- History Section -->
                <div class="dashboard-section">
                    <h3 class="text-lg font-bold font-[Poppins] mb-2">Question History</h3>
                    <div id="historyList" class="max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-2 mb-2"></div>
                    <button id="clearHistoryButton" class="bg-red-200 text-gray-800 rounded-lg px-4 py-2 font-[Poppins] text-sm">Clear History</button>
                </div>
                
                <!-- Exit Section -->
                <div class="dashboard-section">
                    <button id="exitDashboardButton" class="bg-purple-200 text-gray-800 rounded-lg px-4 py-2 font-[Poppins] text-sm w-full">Exit</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Initialize application state
        let isListening = false;
        let recognition = null;
        let synthesis = window.speechSynthesis;
        let microphonePermissionDenied = localStorage.getItem('mrLearningMicDenied') === 'true';
        let permissionAsked = localStorage.getItem('mrLearningMicAsked') === 'true';
        
        // Default PIN is 1234
        let userPin = localStorage.getItem('mrLearningPin') || '1234';
        
        // Initialize banned words list
        let bannedWords = JSON.parse(localStorage.getItem('mrLearningBannedWords')) || [];
        
        // Initialize question history
        let questionHistory = JSON.parse(localStorage.getItem('mrLearningHistory')) || [];
        
        // Grok API key
        const apiKey = 'xai-GIZVljR8NKqZN7VLkXx1H4zTY51VViFLwpeAu1dDCz9BhpRxVPEIGMO5LqH3YVZplkVIlncCW6lqKhbK';
        
        // DOM elements
        const askButton = document.getElementById('askButton');
        const feedback = document.getElementById('feedback');
        const spinner = document.getElementById('spinner');
        const answer = document.getElementById('answer');
        const parentAccessButton = document.getElementById('parentAccessButton');
        const parentModal = document.getElementById('parentModal');
        const pinScreen = document.getElementById('pinScreen');
        const dashboard = document.getElementById('dashboard');
        const voiceOutputToggle = document.getElementById('voiceOutputToggle');
        const voiceOutputStatus = document.getElementById('voiceOutputStatus');
        window.voiceOutputOn = true;
        if (voiceOutputToggle) {
            voiceOutputToggle.addEventListener('change', function() {
                window.voiceOutputOn = this.checked;
                if (voiceOutputStatus) voiceOutputStatus.textContent = this.checked ? 'On' : 'Off';
                if (!this.checked && window.speechSynthesis && window.speechSynthesis.speaking) {
                    window.speechSynthesis.cancel();
                }
            });
        }
        const pinDigits = document.querySelectorAll('.pin-digit');
        const pinError = document.getElementById('pinError');
        const submitPinButton = document.getElementById('submitPinButton');
        const cancelPinButton = document.getElementById('cancelPinButton');
        const newBannedWord = document.getElementById('newBannedWord');
        const addBannedWordButton = document.getElementById('addBannedWordButton');
        const bannedWordsList = document.getElementById('bannedWordsList');
        const newPin = document.getElementById('newPin');
        const confirmPin = document.getElementById('confirmPin');
        const pinChangeError = document.getElementById('pinChangeError');
        const changePinButton = document.getElementById('changePinButton');
        const historyList = document.getElementById('historyList');
        const clearHistoryButton = document.getElementById('clearHistoryButton');
        const exitDashboardButton = document.getElementById('exitDashboardButton');
        const questionInput = document.getElementById('questionInput');
        const textAskButton = document.getElementById('textAskButton');
        
        // Unlock speech synthesis for iOS
        let speechUnlocked = false;
        function unlockSpeechSynthesis() {
            if (speechUnlocked) return;
            speechUnlocked = true;
            if (window.speechSynthesis) {
                const utter = new SpeechSynthesisUtterance(' ');
                utter.volume = 0;
                window.speechSynthesis.speak(utter);
            }
        }
        
        // Stop and release microphone stream on page hide (for iOS recording indicator)
        function stopAudioStream() {
            if (window.audioStream && typeof window.audioStream.getTracks === 'function') {
                window.audioStream.getTracks().forEach(track => track.stop());
                window.audioStream = null;
            }
        }
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopAudioStream();
            }
        });
        window.addEventListener('pagehide', function() {
            stopAudioStream();
        });
        
        // Initialize Web Speech API
        function initializeSpeechRecognition() {
            window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (window.SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'yue-Hant-HK'; // Cantonese
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
                recognition.continuous = false;
                
                recognition.onstart = function() {
                    isListening = true;
                    askButton.querySelector('i').classList.add('pulsing');
                    feedback.textContent = 'Listening...';
                };
                
                recognition.onend = function() {
                    isListening = false;
                    askButton.querySelector('i').classList.remove('pulsing');
                    
                    // Reset button state
                    askButton.classList.remove('bg-red-500');
                    askButton.classList.add('bg-gradient-to-r', 'from-green-500', 'to-green-600');
                };
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    console.log('Transcript:', transcript);
                    
                    // Update the text input with the transcript
                    questionInput.value = transcript;
                    
                    // Check for banned words
                    if (containsBannedWord(transcript)) {
                        feedback.textContent = '';
                        answer.textContent = "Sorry, that's not a good question!";
                        speakText("Sorry, that's not a good question!");
                        return;
                    }
                    
                    // Process the question
                    processQuestion(transcript);
                };
                
                recognition.onerror = function(event) {
                    console.error('Speech recognition error', event.error);
                    isListening = false;
                    askButton.querySelector('i').classList.remove('pulsing');
                    
                    if (event.error === 'not-allowed' || event.error === 'permission-denied') {
                        feedback.textContent = "Please allow microphone access to use voice input.";
                        microphonePermissionDenied = true;
                        localStorage.setItem('mrLearningMicDenied', 'true');
                    } else if (event.error === 'no-speech') {
                        feedback.textContent = "No speech detected. Please try again.";
                    } else if (event.error === 'audio-capture') {
                        feedback.textContent = "No microphone detected. Please connect a microphone.";
                    } else if (event.error === 'network') {
                        feedback.textContent = "Network error. Please check your connection.";
                    } else {
                        feedback.textContent = "Couldn't hear you, try again!";
                    }
                    
                    // Reset button state
                    askButton.classList.remove('bg-red-500');
                    askButton.classList.add('bg-gradient-to-r', 'from-green-500', 'to-green-600');
                };
                
                return true;
            } else {
                feedback.textContent = "Your browser doesn't support voice recognition.";
                return false;
            }
        }
        
        // Check if transcript contains banned words
        function containsBannedWord(transcript) {
            const lowerTranscript = transcript.toLowerCase();
            return bannedWords.some(word => lowerTranscript.includes(word.toLowerCase()));
        }
        
        // Process the question by sending to Grok API
        async function processQuestion(question) {
            feedback.textContent = '';
            spinner.style.display = 'block';
            feedback.textContent = 'Asking Mr. Learning...';
            
            try {
                // Add to history
                const timestamp = new Date().toLocaleString();
                const historyItem = { timestamp, question, answer: '' };
                
                // Call Grok API
                const response = await callGrokAPI(question);
                
                // Update history with answer
                historyItem.answer = response;
                addToHistory(historyItem);
                
                // Display and speak the answer
                spinner.style.display = 'none';
                feedback.textContent = '';
                answer.textContent = response;
                if (window.voiceOutputOn !== false) speakText(response);
            } catch (error) {
                console.error('Error processing question:', error);
                spinner.style.display = 'none';
                feedback.textContent = '';
                answer.textContent = 'Mr. Learning is resting, try again!';
                if (window.voiceOutputOn !== false) speakText('Mr. Learning is resting, try again!');
            }
        }
        
        // Call Grok API
        async function callGrokAPI(question) {
            // Set timeout for API call (10 seconds)
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);
            
            try {
                // Real API call to Grok
                const response = await fetch('https://api.x.ai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'grok-3',
                        max_tokens: 150,
                        messages: [
                            {
                                "role": "system", 
                                "content": "You are Mr. Learning, an educational assistant for children aged 5+. Respond in Cantonese with these guidelines:\n1. Be intellectual and accurate - do not oversimplify concepts\n2. Use simple, clear wording that children can understand\n3. Keep answers concise, precise and to the point (maximum 3-4 sentences)\n4. Avoid personal notes, opinions or unrelated thoughts\n5. Be creative with explanations when needed\n6. Focus purely on delivering factual, educational content\n7. Do not use phrases like 'As Mr. Learning' or refer to yourself\n8. Respond directly to the question without preamble"
                            },
                            {
                                "role": "user", 
                                "content": question
                            }
                        ],
                        temperature: 0.7
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Grok API response:', data);
                return data.choices[0].message.content;
            } catch (error) {
                console.error('Grok API error:', error);
                
                // Fallback responses in case of API failure
                const fallbackResponses = [
                    "你好！我是學習先生。我很高興回答你的問題。",
                    "地球是圓的，就像一個大球。它繞著太陽轉動。",
                    "恐龍是很久以前生活在地球上的大動物。牠們已經滅絕了。",
                    "彩虹是因為陽光通過雨滴而形成的。它有七種顏色。",
                    "星星是在太空中的大火球，就像我們的太陽一樣。"
                ];
                return fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
            }
        }
        
        // Speak text using Speech Synthesis
        function speakText(text) {
            if (synthesis) {
                // Cancel any ongoing speech
                synthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-HK'; // Hong Kong Cantonese
                utterance.pitch = 1.2;
                utterance.rate = 0.95;
                
                // Get available voices
                let voices = synthesis.getVoices();
                console.log('Available voices:', voices.map(v => `${v.name} (${v.lang})`));
                
                // Priority 1: Google Hong Kong voice
                let googleHKVoice = voices.find(voice => 
                    voice.name.includes('Google') && 
                    (voice.lang === 'zh-HK' || voice.lang === 'yue-Hant-HK')
                );
                
                // Priority 2: Any voice with 粵 in the name
                let cantoneseNameVoice = voices.find(voice => 
                    voice.name.includes('粵')
                );
                
                // Priority 3: Any zh-HK voice
                let zhHKVoice = voices.find(voice => 
                    voice.lang === 'zh-HK'
                );
                
                // Priority 4: Any Cantonese voice
                let cantoneseVoice = voices.find(voice => 
                    voice.lang === 'yue-Hant-HK' || 
                    voice.lang.includes('yue')
                );
                
                // Priority 5: Any Chinese voice
                let chineseVoice = voices.find(voice => 
                    voice.lang.includes('zh')
                );
                
                // Use the best voice found based on priority
                if (googleHKVoice) {
                    console.log('Using Google Hong Kong voice:', googleHKVoice.name);
                    utterance.voice = googleHKVoice;
                } else if (cantoneseNameVoice) {
                    console.log('Using voice with 粵 in name:', cantoneseNameVoice.name);
                    utterance.voice = cantoneseNameVoice;
                } else if (zhHKVoice) {
                    console.log('Using zh-HK voice:', zhHKVoice.name);
                    utterance.voice = zhHKVoice;
                } else if (cantoneseVoice) {
                    console.log('Using Cantonese voice:', cantoneseVoice.name);
                    utterance.voice = cantoneseVoice;
                } else if (chineseVoice) {
                    console.log('Using Chinese voice:', chineseVoice.name);
                    utterance.voice = chineseVoice;
                } else {
                    console.warn('No suitable Cantonese voice found, using default voice');
                    // Show a message that Cantonese voice is not available
                    const originalAnswer = answer.textContent;
                    answer.textContent = 'Cantonese voice not supported on this device';
                    
                    // Restore original answer after 3 seconds
                    setTimeout(() => {
                        answer.textContent = originalAnswer;
                    }, 3000);
                }
                
                synthesis.speak(utterance);
            }
        }
        
        // Add item to history
        function addToHistory(item) {
            // Add to beginning of array
            questionHistory.unshift(item);
            
            // Limit to 50 entries
            if (questionHistory.length > 50) {
                questionHistory.pop();
            }
            
            // Save to localStorage
            localStorage.setItem('mrLearningHistory', JSON.stringify(questionHistory));
            
            // Update UI if dashboard is open
            updateHistoryList();
        }
        
        // Update history list in dashboard
        function updateHistoryList() {
            historyList.innerHTML = '';
            
            if (questionHistory.length === 0) {
                historyList.innerHTML = '<p class="text-gray-500 text-center py-2">No history yet</p>';
                return;
            }
            
            questionHistory.forEach((item, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'mb-2 pb-2 border-b border-gray-200 last:border-b-0';
                historyItem.innerHTML = `
                    <p class="text-xs text-gray-500">${item.timestamp}</p>
                    <p class="font-semibold">Q: ${item.question}</p>
                    <p>A: ${item.answer}</p>
                `;
                historyList.appendChild(historyItem);
            });
        }
        
        // Update banned words list in dashboard
        function updateBannedWordsList() {
            bannedWordsList.innerHTML = '';
            
            bannedWords.forEach((word, index) => {
                const wordElement = document.createElement('div');
                wordElement.className = 'bg-red-100 text-red-800 rounded-full px-3 py-1 text-sm flex items-center';
                wordElement.innerHTML = `
                    ${word}
                    <button class="ml-2 text-red-600" data-index="${index}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                bannedWordsList.appendChild(wordElement);
                
                // Add event listener to delete button
                wordElement.querySelector('button').addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    bannedWords.splice(index, 1);
                    localStorage.setItem('mrLearningBannedWords', JSON.stringify(bannedWords));
                    updateBannedWordsList();
                });
            });
            
            if (bannedWords.length === 0) {
                bannedWordsList.innerHTML = '<p class="text-gray-500">No banned words</p>';
            }
        }
        
        // Handle PIN input navigation
        pinDigits.forEach((input, index) => {
            input.addEventListener('input', function() {
                if (this.value.length === 1) {
                    if (index < pinDigits.length - 1) {
                        pinDigits[index + 1].focus();
                    } else {
                        submitPinButton.focus();
                    }
                }
            });
            
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Backspace' && this.value.length === 0 && index > 0) {
                    pinDigits[index - 1].focus();
                }
            });
        });
        
        // Event Listeners
        
        // Request microphone permission explicitly
        function requestMicrophonePermission() {
            return new Promise((resolve, reject) => {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        // Keep the stream active to maintain permission
                        window.audioStream = stream;
                        
                        microphonePermissionDenied = false;
                        permissionAsked = true;
                        
                        // Store permission status in localStorage
                        localStorage.setItem('mrLearningMicDenied', 'false');
                        localStorage.setItem('mrLearningMicAsked', 'true');
                        
                        resolve(true);
                    })
                    .catch(err => {
                        console.error('Microphone permission denied:', err);
                        microphonePermissionDenied = true;
                        permissionAsked = true;
                        
                        // Store permission status in localStorage
                        localStorage.setItem('mrLearningMicDenied', 'true');
                        localStorage.setItem('mrLearningMicAsked', 'true');
                        
                        feedback.textContent = "Please allow microphone access to use voice input.";
                        reject(err);
                    });
            });
        }
        
        // Ask button click
        askButton.addEventListener('click', async function() {
            unlockSpeechSynthesis();
            if (isListening) {
                // Stop listening if already active
                if (recognition) {
                    recognition.stop();
                }
            } else {
                // Clear previous answer
                answer.textContent = '';
                
                // Clear text input
                questionInput.value = '';
                
                // Check if we need to request permission
                if (!permissionAsked || (permissionAsked && microphonePermissionDenied)) {
                    try {
                        await requestMicrophonePermission();
                    } catch (err) {
                        // If permission is still denied, just show a message
                        if (microphonePermissionDenied) {
                            feedback.textContent = "Please allow microphone access in your browser settings.";
                            return;
                        }
                    }
                }
                
                // Initialize speech recognition if not already
                if (!recognition) {
                    if (!initializeSpeechRecognition()) {
                        return;
                    }
                }
                
                // Start listening
                try {
                    // If we have an active audio stream, use it
                    if (window.audioStream) {
                        // Make sure it's still active
                        if (window.audioStream.active) {
                            console.log('Using existing audio stream');
                        } else {
                            // If not active, request a new one
                            console.log('Audio stream not active, requesting new one');
                            await requestMicrophonePermission();
                        }
                    }
                    
                    recognition.start();
                } catch (error) {
                    console.error('Error starting recognition:', error);
                    feedback.textContent = "Couldn't start listening. Try again!";
                    
                    // Try to request permission again as a fallback
                    try {
                        await requestMicrophonePermission();
                        // Try starting recognition again
                        recognition.start();
                    } catch (err) {
                        feedback.textContent = "Please allow microphone access in your browser settings.";
                    }
                }
            }
        });
        
        // Parent access button click
        parentAccessButton.addEventListener('click', function() {
            // Reset PIN input fields
            pinDigits.forEach(input => {
                input.value = '';
            });
            pinError.classList.add('hidden');
            
            // Show modal with PIN screen
            parentModal.style.display = 'flex';
            pinScreen.style.display = 'block';
            dashboard.style.display = 'none';
            
            // Focus on first PIN digit
            pinDigits[0].focus();
        });
        
        // Submit PIN button click
        submitPinButton.addEventListener('click', function() {
            const enteredPin = Array.from(pinDigits).map(input => input.value).join('');
            
            if (enteredPin === userPin) {
                // Show dashboard
                pinScreen.style.display = 'none';
                dashboard.style.display = 'block';
                
                // Update dashboard content
                updateBannedWordsList();
                updateHistoryList();
            } else {
                // Show error
                pinError.classList.remove('hidden');
                
                // Clear PIN input
                pinDigits.forEach(input => {
                    input.value = '';
                });
                
                // Focus on first digit
                pinDigits[0].focus();
            }
        });
        
        // Cancel PIN button click
        cancelPinButton.addEventListener('click', function() {
            parentModal.style.display = 'none';
        });
        
        // Add banned word button click
        addBannedWordButton.addEventListener('click', function() {
            const word = newBannedWord.value.trim();
            
            if (word && !bannedWords.includes(word)) {
                bannedWords.push(word);
                localStorage.setItem('mrLearningBannedWords', JSON.stringify(bannedWords));
                newBannedWord.value = '';
                updateBannedWordsList();
            }
        });
        
        // Change PIN button click
        changePinButton.addEventListener('click', function() {
            const newPinValue = newPin.value;
            const confirmPinValue = confirmPin.value;
            
            if (newPinValue.length !== 4 || !/^\d{4}$/.test(newPinValue) || newPinValue !== confirmPinValue) {
                pinChangeError.classList.remove('hidden');
                return;
            }
            
            userPin = newPinValue;
            localStorage.setItem('mrLearningPin', userPin);
            
            pinChangeError.classList.add('hidden');
            newPin.value = '';
            confirmPin.value = '';
            
            // Show confirmation
            pinChangeError.textContent = 'PIN updated successfully!';
            pinChangeError.classList.remove('hidden', 'text-red-500');
            pinChangeError.classList.add('text-green-500');
            
            // Hide confirmation after 3 seconds
            setTimeout(() => {
                pinChangeError.classList.add('hidden');
            }, 3000);
        });
        
        // Clear history button click
        clearHistoryButton.addEventListener('click', function() {
            questionHistory = [];
            localStorage.setItem('mrLearningHistory', JSON.stringify(questionHistory));
            updateHistoryList();
        });
        
        // Exit dashboard button click
        exitDashboardButton.addEventListener('click', function() {
            parentModal.style.display = 'none';
        });
        
        // Text ask button click
        textAskButton.addEventListener('click', function() {
            unlockSpeechSynthesis();
            const question = questionInput.value.trim();
            
            if (!question) {
                return;
            }
            
            // Clear previous answer
            answer.textContent = '';
            
            // Check for banned words
            if (containsBannedWord(question)) {
                feedback.textContent = '';
                answer.textContent = "Sorry, that's not a good question!";
                speakText("Sorry, that's not a good question!");
                return;
            }
            
            // Process the question
            processQuestion(question);
        });
        
        // Allow Enter key to submit text question
        questionInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                textAskButton.click();
            }
        });
        
        // Close modal when clicking outside
        parentModal.addEventListener('click', function(event) {
            if (event.target === parentModal) {
                parentModal.style.display = 'none';
            }
        });
        
        // Initialize voices for speech synthesis
        if (synthesis) {
            // Chrome needs this event to get voices
            if (synthesis.onvoiceschanged !== undefined) {
                synthesis.onvoiceschanged = function() {
                    console.log('Voices loaded:', synthesis.getVoices().length);
                };
            }
        }
        
        // Initialize the application
        function init() {
            // Check if Web Speech API is supported
            if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
                askButton.disabled = true;
                feedback.textContent = "Your browser doesn't support voice recognition.";
            }
            
            if (!('speechSynthesis' in window)) {
                console.warn("Speech synthesis not supported");
            }
            
            // Check if we're on a secure context (needed for getUserMedia)
            if (window.isSecureContext) {
                // Only request permission on first visit or if previously granted
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    // Check if we've asked for permission before
                    if (!permissionAsked || (permissionAsked && !microphonePermissionDenied)) {
                        // Request permission on page load
                        requestMicrophonePermission()
                            .then(() => {
                                console.log('Microphone permission granted on page load');
                            })
                            .catch(err => {
                                console.warn('Microphone permission not granted on page load:', err);
                            });
                    }
                }
            } else {
                console.warn('Not a secure context, microphone access may be restricted');
                feedback.textContent = "Please use HTTPS for voice recognition.";
            }
        }
        
        // Run initialization
        init();
    </script>
</body>
</html>
